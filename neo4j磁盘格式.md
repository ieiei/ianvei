# 理解Neo4j在磁盘中存的数据

> 原文链接：understanding data on disk

Neo4j数据库文件是持久存储的，以实现长期持久性。默认情况下，Neo4j的数据相关文件存储在data / databases / graph.db（v3.x +）中。以下将告诉你以neostore.*开头的文件类型的概念以及这些文件具体存储的哪些数据：

- nodestore* 存储着图形中与节点相关的数据
- relationship* 存储着与图形中创建和定义的关系相关的数据
- property* 存储着数据库中的键/值属性
- label* 存储着图形中与索引相关的标签数据

由于Neo4j是一个无模式的数据库，因此我们使用固定的记录长度来存储数据并根据这些文件中的偏移量来知道如何获取数据回答查询。下表说明了Neo4j用于存储的Java对象类型的固定大小：

| Store File                        | Record size | Contents                               |
| --------------------------------- | ----------- | -------------------------------------- |
| neostore.nodestore.db             | 15B         | Nodes                                  |
| neostore.relationshipstore.db     | 34B         | Relationships                          |
| neostore.propertystore.db         | 41B         | Properties for nodes and relationships |
| neostore.propertystore.db.strings | 128B        | Values of string properties            |
| neostore.propertystore.db.arrays  | 128B        | Values of array properties             |

有关属性的一些注意事项：

- 该属性记录的有效载荷为32bytes，分为四个8B块。每个字段可以包含一个键或一个值，或者既可以包含键又可以包含一个值。
- 键和具体数据类型共占用3.5个字节（键4位，类型24位）
- boolean, byte, short, int, char, float塞入到同一块的剩余字节
- small long也同样塞入到同一块中
- big long 或者 double存储在分离的块中（意味着该属性使用了两个块）
- 对字符串或数组的引用(reference)存储在与键同一块中
- 如果short string或者short array 能存入到剩余的块（包括键块的剩余字节），则将其存储在同一记录中
- 存不入8B块中的long strings/arrays将存储一个指向字符串/数组存储区（128B）中的记录的指针
- ...其他类型的则更加复杂！

存储在磁盘上的数据是固定大小记录的链表结构。属性是以属性记录的链表形式存储，每个都包含键和值并指向下一个属性。每个节点和关系都引用其第一个属性记录。节点还引用其关系链中的第一个关系。每个关系都引用其开始和结束节点。它还分别引用了起始节点和结束节点的上一个和下一个关系记录。

一个基本的磁盘空间计算例子可能类似于：

> 为了简单起见，我们假定属性与属性记录的比率为1：1，这意味着一个属性始终为41B。显然，根据上述考虑，这没有真实场景那么琐碎复杂。

场景#1 –初始状态

- 节点数量：4M个节点

  - 每个节点具有3个属性（总共12M个属性）

- 关系数量：2M个关系

- - 每个节点具有1个属性（总共2M个属性）

这将转换为以下的磁盘大小：

- 节点：4.000.000x15B = 60.000.000B (60MB)
- 关系：2.000.000x34B = 68.000.000B (68MB)
- 属性：14.000.000x41B = 574.000.000B (574MB)
- 总共： **703MB**

场景#2 –4倍的增长 + 增加的属性 + 所有属性的索引

- 节点数量：16M个节点

- - 每个节点具有5个属性（总共80M个属性）

- 关系数量：8M个关系

- - 每个节点具有2个属性（总共16M个属性）

这将转换为以下的磁盘大小：

- 节点：16.000.000x15B = 240.000.000B (240MB)
- 关系：8.000.000x34B = 272.000.000B (272MB)
- 属性：96.000.000x41B = 3.936.000.000B (3936MB)
- 索引：4448MB * ~33% = 1468MB
- 总共： **5916MB**